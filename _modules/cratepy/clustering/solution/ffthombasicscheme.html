<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cratepy.clustering.solution.ffthombasicscheme &mdash; CRATE 1.0.4 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/readthedocs-custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            CRATE
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/getting_started/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/getting_started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/getting_started/run_benchmark.html">Run a benchmark</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Basic usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/basic_usage/general_workflow.html">General workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/basic_usage/step1_material_model.html">Step 1: Material model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/basic_usage/step2_input_data.html">Step 2: Input data file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/basic_usage/step3_simulation.html">Step 3: Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/basic_usage/step4_post_processing.html">Step 4: Post-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/basic_usage/available_features.html">Available features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Validation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/validation/benchmarks.html">Benchmarks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/advanced_usage/customization.html">Customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/advanced_usage/interface_dns_solver.html">Interface: DNS solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/advanced_usage/interface_clustering_feature.html">Interface: Clustering feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/advanced_usage/interface_clustering_algorithm.html">Interface: Clustering algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/advanced_usage/interface_constitutive_model.html">Interface: Constitutive model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst_doc_files/reference/index.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/cratepy.html">Code</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">License</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">BSD 3-Clause License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">CRATE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">cratepy.clustering.solution.ffthombasicscheme</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cratepy.clustering.solution.ffthombasicscheme</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;FFT-based homogenization basic scheme multi-scale method.</span>

<span class="sd">This module includes the implementation of the FFT-based homogenization basic</span>
<span class="sd">scheme proposed by Moulinec and Suquet (1998) [1]_ for the solution of</span>
<span class="sd">micro-scale equilibrium problems of linear elastic heterogeneous materials. The</span>
<span class="sd">finite strain extension of this method is also implemented by following the</span>
<span class="sd">formulation of Kabel and coworkers (2022) [2]_ and adopting the Hencky</span>
<span class="sd">hyperelastic constitutive model. It also includes a class that handles a</span>
<span class="sd">general incrementation of the macroscale strain loading and a dynamic</span>
<span class="sd">subincrementation scheme.</span>

<span class="sd">.. [1] Moulinec, H. and Suquet, P. (1998). *A numerical method for computing</span>
<span class="sd">       the overall response of nonlinear composites with complex</span>
<span class="sd">       microstructure.* Comp Methods Appl M, 157:69-94 (see `here</span>
<span class="sd">       &lt;https://www.sciencedirect.com/science/article/pii/S0045782597002181&gt;`_)</span>

<span class="sd">.. [2] Kabel, M., Bohlke, T., and Schneider, M. (2014). *Efficient fixed point</span>
<span class="sd">       and Newton-Krylov solver for FFT-based homogenization of elasticity</span>
<span class="sd">       at large deformations.* Comp Methods Appl M, 54:1497-1514 (see `here</span>
<span class="sd">       &lt;https://link.springer.com/article/10.1007/s00466-014-1071-8&gt;`_)</span>

<span class="sd">Classes</span>
<span class="sd">-------</span>
<span class="sd">FFTBasicScheme</span>
<span class="sd">    FFT-based homogenization basic scheme.</span>
<span class="sd">MacroscaleStrainIncrementer</span>
<span class="sd">    Macroscale strain loading incrementer.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#                                                                       Modules</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Standard</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="c1"># Third-party</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span>
<span class="kn">import</span> <span class="nn">colorama</span>
<span class="c1"># Local</span>
<span class="kn">import</span> <span class="nn">ioput.ioutilities</span> <span class="k">as</span> <span class="nn">ioutil</span>
<span class="kn">import</span> <span class="nn">tensor.tensoroperations</span> <span class="k">as</span> <span class="nn">top</span>
<span class="kn">import</span> <span class="nn">tensor.matrixoperations</span> <span class="k">as</span> <span class="nn">mop</span>
<span class="kn">import</span> <span class="nn">clustering.citoperations</span> <span class="k">as</span> <span class="nn">citop</span>
<span class="kn">from</span> <span class="nn">clustering.solution.dnshomogenization</span> <span class="kn">import</span> <span class="n">DNSHomogenizationMethod</span>
<span class="c1">#</span>
<span class="c1">#                                                          Authorship &amp; Credits</span>
<span class="c1"># =============================================================================</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Bernardo Ferreira (bernardo_ferreira@brown.edu)&#39;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bernardo Ferreira&#39;</span><span class="p">,</span> <span class="p">]</span>
<span class="n">__status__</span> <span class="o">=</span> <span class="s1">&#39;Stable&#39;</span>
<span class="c1"># =============================================================================</span>
<span class="c1">#</span>
<span class="c1"># =============================================================================</span>
<div class="viewcode-block" id="FFTBasicScheme"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme">[docs]</a><span class="k">class</span> <span class="nc">FFTBasicScheme</span><span class="p">(</span><span class="n">DNSHomogenizationMethod</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FFT-based homogenization basic scheme.</span>

<span class="sd">    FFT-based homogenization basic scheme proposed by Moulinec and Suquet</span>
<span class="sd">    (1998) [#]_ for the solution of micro-scale equilibrium problems of linear</span>
<span class="sd">    elastic heterogeneous materials. In particular, for a given RVE discretized</span>
<span class="sd">    in a regular grid of voxels, the method solves the microscale equilibrium</span>
<span class="sd">    problem when the RVE is subjected to a macroscale strain tensor and is</span>
<span class="sd">    constrained by periodic boundary conditions. Finite strain extension</span>
<span class="sd">    is also available, following the formulation of Kabel and coworkers</span>
<span class="sd">    (2022) [#]_ and adopting the Hencky hyperelastic constitutive model.</span>

<span class="sd">    A detailed description of the computational implementation can be found</span>
<span class="sd">    in Appendix B (infinitesimal strains) and Section 4.6 (finite strains)</span>
<span class="sd">    of Ferreira (2022) [#]_.</span>

<span class="sd">    .. [#] Moulinec, H. and Suquet, P. (1998). *A numerical method for</span>
<span class="sd">           computing the overall response of nonlinear composites with complex</span>
<span class="sd">           microstructure.* Comp Methods Appl M, 157:69-94 (see `here</span>
<span class="sd">           &lt;https://www.sciencedirect.com/science/article/pii/</span>
<span class="sd">           S0045782597002181&gt;`_)</span>

<span class="sd">    .. [#] Kabel, M., Bohlke, T., and Schneider, M. (2014). *Efficient fixed</span>
<span class="sd">           point and Newton-Krylov solver for FFT-based homogenization of</span>
<span class="sd">           elasticity at large deformations.* Comp Methods Appl M, 54:1497-1514</span>
<span class="sd">           (see `here &lt;https://link.springer.com/article/10.1007/</span>
<span class="sd">           s00466-014-1071-8&gt;`_)</span>

<span class="sd">    .. [#] Ferreira, B.P. (2022). *Towards Data-driven Multi-scale Optimization</span>
<span class="sd">           of Thermoplastic Blends: Microstructural Generation, Constitutive</span>
<span class="sd">           Development and Clustering-based Reduced-Order Modeling.*</span>
<span class="sd">           PhD Thesis, University of Porto (see `here &lt;https://</span>
<span class="sd">           repositorio-aberto.up.pt/handle/10216/146900?locale=en&gt;`_)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    _n_dim : int</span>
<span class="sd">        Problem number of spatial dimensions.</span>
<span class="sd">    _comp_order_sym : list[str]</span>
<span class="sd">        Strain/Stress components symmetric order.</span>
<span class="sd">    _comp_order_nsym : list[str]</span>
<span class="sd">        Strain/Stress components nonsymmetric order.</span>
<span class="sd">    _max_n_iterations : int</span>
<span class="sd">        Maximum number of iterations to convergence.</span>
<span class="sd">    _conv_criterion : {&#39;stress_div&#39;, &#39;avg_stress_norm&#39;}</span>
<span class="sd">        Convergence criterion: &#39;stress_div&#39; is the original convergence</span>
<span class="sd">        criterion based on the evaluation of the divergence of the stress</span>
<span class="sd">        tensor; &#39;avg_stress_norm&#39; is based on the iterative change of the</span>
<span class="sd">        average stress norm.</span>
<span class="sd">    _conv_tol : float</span>
<span class="sd">        Convergence tolerance.</span>
<span class="sd">    _max_subinc_level : int</span>
<span class="sd">        Maximum level of macroscale loading subincrementation.</span>
<span class="sd">    _max_cinc_cuts : int</span>
<span class="sd">        Maximum number of consecutive macroscale loading increment cuts.</span>
<span class="sd">    _hom_stress_strain : numpy.ndarray (2d)</span>
<span class="sd">        Homogenized stress-strain material response. The homogenized strain and</span>
<span class="sd">        homogenized stress tensor components of the i-th loading increment are</span>
<span class="sd">        stored columnwise in the i-th row, sorted respectively. Infinitesimal</span>
<span class="sd">        strain tensor and Cauchy stress tensor (infinitesimal strains) or</span>
<span class="sd">        Deformation gradient and first Piola-Kirchhoff stress tensor (finite</span>
<span class="sd">        strains).</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    compute_rve_local_response(self, mac_strain_id, mac_strain, verbose=False)</span>
<span class="sd">        Compute RVE local elastic strain response.</span>
<span class="sd">    _elastic_constitutive_model(self, strain_vox, evar1, evar2, evar3, \</span>
<span class="sd">                                finite_strains_model=&#39;stvenant-kirchhoff&#39;, \</span>
<span class="sd">                                is_optimized=True)</span>
<span class="sd">        Elastic or hyperelastic material constitutive model.</span>
<span class="sd">    stress_div_conv_criterion(self, freqs_dims, stress_DFT_vox)</span>
<span class="sd">        Convergence criterion based on the divergence of the stress tensor.</span>
<span class="sd">    compute_avg_state_vox(self, state_vox)</span>
<span class="sd">        Compute average norm of strain or stress local field.</span>
<span class="sd">    _compute_homogenized_field(self, state_vox)</span>
<span class="sd">        Perform homogenization over regular grid spatial discretization.</span>
<span class="sd">    get_hom_stress_strain(self)</span>
<span class="sd">        Get homogenized strain-stress material response.</span>
<span class="sd">    _display_greetings()</span>
<span class="sd">        Output greetings.</span>
<span class="sd">    _display_increment_init(inc, subinc_level, total_lfact, inc_lfact)</span>
<span class="sd">        Output increment initial data.</span>
<span class="sd">    _display_increment_end(strain_formulation, hom_strain, hom_stress, \</span>
<span class="sd">                           inc_time, total_time)</span>
<span class="sd">        Output increment end data.</span>
<span class="sd">    _display_iteration(iter, iter_time, discrete_error)</span>
<span class="sd">        Output iteration data.</span>
<span class="sd">    _display_increment_cut(cut_msg=&#39;&#39;)</span>
<span class="sd">        Output increment cut data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="FFTBasicScheme.__init__"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strain_formulation</span><span class="p">,</span> <span class="n">problem_type</span><span class="p">,</span> <span class="n">rve_dims</span><span class="p">,</span>
                 <span class="n">n_voxels_dims</span><span class="p">,</span> <span class="n">regular_grid</span><span class="p">,</span> <span class="n">material_phases</span><span class="p">,</span>
                 <span class="n">material_phases_properties</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        strain_formulation: {&#39;infinitesimal&#39;, &#39;finite&#39;}</span>
<span class="sd">            Problem strain formulation.</span>
<span class="sd">        problem_type : int</span>
<span class="sd">            Problem type: 2D plane strain (1), 2D plane stress (2),</span>
<span class="sd">            2D axisymmetric (3) and 3D (4).</span>
<span class="sd">        rve_dims : list[float]</span>
<span class="sd">            RVE size in each dimension.</span>
<span class="sd">        n_voxels_dims : list[int]</span>
<span class="sd">            Number of voxels in each dimension of the regular grid (spatial</span>
<span class="sd">            discretization of the RVE).</span>
<span class="sd">        regular_grid : numpy.ndarray (2d or 3d)</span>
<span class="sd">            Regular grid of voxels (spatial discretization of the RVE), where</span>
<span class="sd">            each entry contains the material phase label (int) assigned to the</span>
<span class="sd">            corresponding voxel.</span>
<span class="sd">        material_phases : list[str]</span>
<span class="sd">            RVE material phases labels (str).</span>
<span class="sd">        material_phases_properties : dict</span>
<span class="sd">            Constitutive model material properties (item, dict) associated to</span>
<span class="sd">            each material phase (key, str).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">=</span> <span class="n">strain_formulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_problem_type</span> <span class="o">=</span> <span class="n">problem_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rve_dims</span> <span class="o">=</span> <span class="n">rve_dims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span> <span class="o">=</span> <span class="n">n_voxels_dims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regular_grid</span> <span class="o">=</span> <span class="n">regular_grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_material_phases</span> <span class="o">=</span> <span class="n">material_phases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_material_phases_properties</span> <span class="o">=</span> <span class="n">material_phases_properties</span>
        <span class="c1"># Get problem type parameters</span>
        <span class="n">n_dim</span><span class="p">,</span> <span class="n">comp_order_sym</span><span class="p">,</span> <span class="n">comp_order_nsym</span> <span class="o">=</span> \
            <span class="n">mop</span><span class="o">.</span><span class="n">get_problem_type_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span> <span class="o">=</span> <span class="n">n_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span> <span class="o">=</span> <span class="n">comp_order_sym</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_nsym</span> <span class="o">=</span> <span class="n">comp_order_nsym</span>
        <span class="c1"># Set maximum number of iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_n_iterations</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="c1"># Set convergence criterion and tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conv_criterion</span> <span class="o">=</span> <span class="s1">&#39;avg_stress_norm&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conv_tol</span> <span class="o">=</span> <span class="mf">1e-4</span>
        <span class="c1"># Set macroscale loading subincrementation parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_subinc_level</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_cinc_cuts</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="c1"># Initialize homogenized strain-stress response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hom_stress_strain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_dim</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;finite&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hom_stress_strain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FFTBasicScheme.compute_rve_local_response"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.compute_rve_local_response">[docs]</a>    <span class="k">def</span> <span class="nf">compute_rve_local_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mac_strain_id</span><span class="p">,</span> <span class="n">mac_strain</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute RVE local elastic strain response.</span>

<span class="sd">        Compute the RVE local strain response (solution of microscale</span>
<span class="sd">        equilibrium problem) when subjected to a given macroscale strain</span>
<span class="sd">        loading, namely a macroscale infinitesimal strain tensor (infinitesimal</span>
<span class="sd">        strains) or a macroscale deformation gradient (finite strains). It is</span>
<span class="sd">        assumed that the RVE is spatially discretized in a regular grid of</span>
<span class="sd">        voxels.</span>

<span class="sd">        ----</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mac_strain_id : int</span>
<span class="sd">            Macroscale strain second-order tensor identifier.</span>
<span class="sd">        mac_strain : numpy.ndarray (2d)</span>
<span class="sd">            Macroscale strain second-order tensor. Infinitesimal strain tensor</span>
<span class="sd">            (infinitesimal strains) or deformation gradient (finite strains).</span>
<span class="sd">        verbose : bool, default=False</span>
<span class="sd">            Enable verbose output.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        strain_vox: dict</span>
<span class="sd">            RVE local strain response (item, numpy.ndarray of shape equal to</span>
<span class="sd">            RVE regular grid discretization) for each strain component</span>
<span class="sd">            (key, str). Infinitesimal strain tensor (infinitesimal strains) or</span>
<span class="sd">            material logarithmic strain tensor (finite strains).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set initial time</span>
        <span class="n">init_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># Display greetings</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_display_greetings</span><span class="p">()</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Store total macroscale strain tensor</span>
        <span class="n">mac_strain_total</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mac_strain</span><span class="p">)</span>
        <span class="c1"># Initialize macroscale strain increment cut flag</span>
        <span class="n">is_inc_cut</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Set strain/stress components order according to problem strain</span>
        <span class="c1"># formulation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span><span class="p">:</span>
            <span class="c1"># Infinitesimal strain tensor and Cauchy stress tensor</span>
            <span class="n">comp_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;finite&#39;</span><span class="p">:</span>
            <span class="c1"># Deformation gradient and First Piola-Kirchhoff stress tensor</span>
            <span class="n">comp_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_nsym</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unknown problem strain formulation.&#39;</span><span class="p">)</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Initialize homogenized strain-stress response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hom_stress_strain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;finite&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hom_stress_strain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="c1">#</span>
        <span class="c1">#                                    Material phases elasticity tensors</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Set elastic properties-related optimized variables</span>
        <span class="n">evar1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">))</span>
        <span class="n">evar2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">mat_phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_material_phases</span><span class="p">:</span>
            <span class="c1"># Get material phase elastic properties</span>
            <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_material_phases_properties</span><span class="p">[</span><span class="n">mat_phase</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_material_phases_properties</span><span class="p">[</span><span class="n">mat_phase</span><span class="p">][</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
            <span class="c1"># Build optimized variables</span>
            <span class="n">evar1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_regular_grid</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">mat_phase</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">E</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">v</span><span class="p">))</span>
            <span class="n">evar2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_regular_grid</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">mat_phase</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">v</span><span class="p">)))</span>
        <span class="n">evar3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">evar1</span><span class="p">,</span> <span class="n">evar2</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1">#                                 Reference material elastic properties</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Set reference material elastic properties as the mean between the</span>
        <span class="c1"># minimum and maximum values existent among the microstructure&#39;s</span>
        <span class="c1"># material phases (proposed by Moulinec and Suquet (1998))</span>
        <span class="n">mat_prop_ref</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">mat_prop_ref</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_material_phases_properties</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_material_phases</span><span class="p">])</span>
                 <span class="o">+</span> <span class="nb">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_material_phases_properties</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_material_phases</span><span class="p">]))</span>
        <span class="n">mat_prop_ref</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_material_phases_properties</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_material_phases</span><span class="p">])</span>
                 <span class="o">+</span> <span class="nb">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_material_phases_properties</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_material_phases</span><span class="p">]))</span>
        <span class="c1">#</span>
        <span class="c1">#                                              Frequency discretization</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Set discrete frequencies (rad/m) for each dimension</span>
        <span class="n">freqs_dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">):</span>
            <span class="c1"># Set sampling spatial period</span>
            <span class="n">sampling_period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rve_dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># Set discrete frequencies</span>
            <span class="n">freqs_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                     <span class="n">sampling_period</span><span class="p">))</span>
        <span class="c1">#</span>
        <span class="c1">#                                     Reference material Green operator</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Get reference material Young modulus and Poisson coeficient</span>
        <span class="n">E_ref</span> <span class="o">=</span> <span class="n">mat_prop_ref</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">]</span>
        <span class="n">v_ref</span> <span class="o">=</span> <span class="n">mat_prop_ref</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
        <span class="c1"># Compute reference material Lamé parameters</span>
        <span class="n">lam_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">E_ref</span><span class="o">*</span><span class="n">v_ref</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">v_ref</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">v_ref</span><span class="p">))</span>
        <span class="n">miu_ref</span> <span class="o">=</span> <span class="n">E_ref</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">v_ref</span><span class="p">))</span>
        <span class="c1"># Compute Green operator reference material related constants</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span><span class="p">:</span>
            <span class="c1"># Symmetrized isotropic reference material elasticity tensor</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">4.0</span><span class="o">*</span><span class="n">miu_ref</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">miu_ref</span> <span class="o">+</span> <span class="n">lam_ref</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">miu_ref</span><span class="o">*</span><span class="p">(</span><span class="n">lam_ref</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">miu_ref</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Non-symmetrized isotropic reference material elasticity tensor</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">miu_ref</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">lam_ref</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">miu_ref</span><span class="o">*</span><span class="p">(</span><span class="n">lam_ref</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">miu_ref</span><span class="p">))</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Compute Green operator material independent terms</span>
        <span class="n">gop_1_dft_vox</span><span class="p">,</span> <span class="n">gop_2_dft_vox</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
            <span class="n">citop</span><span class="o">.</span><span class="n">gop_material_independent_terms</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_problem_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rve_dims</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">)</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Set Green operator matricial form components</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">comp_order</span><span class="p">,</span> <span class="n">comp_order</span><span class="p">))</span>
        <span class="c1"># Set mapping between Green operator fourth-order tensor and matricial</span>
        <span class="c1"># form components</span>
        <span class="n">fo_indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">mf_indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comp_order</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">fo_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                               <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">comps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">comps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>
            <span class="n">mf_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">comp_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">comps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                           <span class="n">comp_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">comps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])]])</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Initialize Green operator</span>
        <span class="n">gop_dft_vox</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]):</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">))</span>
                       <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">fo_indexes</span><span class="p">}</span>
        <span class="c1"># Compute Green operator matricial form components</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf_indexes</span><span class="p">)):</span>
            <span class="c1"># Get fourth-order tensor indexes</span>
            <span class="n">fo_idx</span> <span class="o">=</span> <span class="n">fo_indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># Get Green operator component</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fo_idx</span><span class="p">])</span>
            <span class="c1"># Compute Green operator matricial form component</span>
            <span class="n">gop_dft_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">c1</span><span class="o">*</span><span class="n">gop_1_dft_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="n">gop_2_dft_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1">#                              Macroscale strain loading incrementation</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Set number of increments</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span><span class="p">:</span>
            <span class="n">n_incs</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_incs</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Set incremental load factors</span>
        <span class="n">inc_lfacts</span> <span class="o">=</span> <span class="n">n_incs</span><span class="o">*</span><span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="n">n_incs</span><span class="p">,</span> <span class="p">]</span>
        <span class="c1"># Initialize macroscale strain incrementer</span>
        <span class="n">mac_strain_incrementer</span> <span class="o">=</span> <span class="n">MacroscaleStrainIncrementer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_problem_type</span><span class="p">,</span> <span class="n">mac_strain_total</span><span class="p">,</span>
            <span class="n">inc_lfacts</span><span class="o">=</span><span class="n">inc_lfacts</span><span class="p">,</span> <span class="n">max_subinc_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_subinc_level</span><span class="p">,</span>
            <span class="n">max_cinc_cuts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_cinc_cuts</span><span class="p">)</span>
        <span class="c1"># Set first macroscale strain increment</span>
        <span class="n">mac_strain_incrementer</span><span class="o">.</span><span class="n">update_inc</span><span class="p">()</span>
        <span class="c1"># Get current macroscale strain tensor</span>
        <span class="n">mac_strain</span> <span class="o">=</span> <span class="n">mac_strain_incrementer</span><span class="o">.</span><span class="n">get_current_mac_strain</span><span class="p">()</span>
        <span class="c1"># Display increment data</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_display_increment_init</span><span class="p">(</span>
                <span class="o">*</span><span class="n">mac_strain_incrementer</span><span class="o">.</span><span class="n">get_inc_output_data</span><span class="p">())</span>
        <span class="c1"># Set increment initial time</span>
        <span class="n">inc_init_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># Set iteration initial time</span>
        <span class="n">iter_init_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1">#                                   Macroscale loading incremental loop</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Start macroscale loading incremental loop</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1">#                                           Initial iterative guess</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Set initial iterative guess</span>
            <span class="k">if</span> <span class="n">mac_strain_incrementer</span><span class="o">.</span><span class="n">get_inc</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Initialize strain tensor</span>
                <span class="n">strain_vox</span> <span class="o">=</span> <span class="p">{</span><span class="n">comp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">))</span>
                              <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_order</span><span class="p">}</span>
                <span class="c1"># Set strain initial iterative guess</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_order</span><span class="p">:</span>
                    <span class="c1"># Get strain component indexes</span>
                    <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                    <span class="c1"># Initial guess: Macroscale strain tensor</span>
                    <span class="n">strain_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regular_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                               <span class="n">mac_strain</span><span class="p">[</span><span class="n">so_idx</span><span class="p">])</span>
                <span class="c1"># Initialize last converged strain tensor</span>
                <span class="n">strain_old_vox</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">strain_vox</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Initial guess: Last converged strain field</span>
                <span class="n">strain_vox</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">strain_old_vox</span><span class="p">)</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Compute stress initial iterative guess</span>
            <span class="n">stress_vox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elastic_constitutive_model</span><span class="p">(</span><span class="n">strain_vox</span><span class="p">,</span> <span class="n">evar1</span><span class="p">,</span>
                                                          <span class="n">evar2</span><span class="p">,</span> <span class="n">evar3</span><span class="p">)</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Compute average strain/stress norm</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv_criterion</span> <span class="o">==</span> <span class="s1">&#39;avg_stress_norm&#39;</span><span class="p">:</span>
                <span class="c1"># Compute initial guess average stress norm</span>
                <span class="n">avg_stress_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_avg_state_vox</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">)</span>
                <span class="c1"># Initialize last iteration average stress norm</span>
                <span class="n">avg_stress_norm_itold</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1">#</span>
            <span class="c1">#                           Strain Discrete Fourier Transform (DFT)</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Compute strain Discrete Fourier Transform (DFT)</span>
            <span class="n">strain_DFT_vox</span> <span class="o">=</span> <span class="p">{</span><span class="n">comp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">),</span>
                                             <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_order</span><span class="p">}</span>
            <span class="c1"># Loop over strain components</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_order</span><span class="p">:</span>
                <span class="c1"># Discrete Fourier Transform (DFT) by means of Fast Fourier</span>
                <span class="c1"># Transform (FFT)</span>
                <span class="n">strain_DFT_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">strain_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Initialize macroscale strain voxelwise tensor</span>
            <span class="n">mac_strain_vox</span> <span class="o">=</span> <span class="p">{</span><span class="n">comp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">))</span>
                              <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_order</span><span class="p">}</span>
            <span class="n">mac_strain_DFT_vox</span> <span class="o">=</span> <span class="p">{</span><span class="n">comp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">),</span>
                                                 <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_order</span><span class="p">}</span>
            <span class="c1"># Enforce macroscale strain DFT at the zero-frequency</span>
            <span class="n">freq_0_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="o">*</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
            <span class="n">mac_strain_DFT_0</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_order</span><span class="p">:</span>
                <span class="c1"># Get strain component indexes</span>
                <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                <span class="c1"># Compute macroscale strain DFT</span>
                <span class="n">mac_strain_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regular_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                               <span class="n">mac_strain</span><span class="p">[</span><span class="n">so_idx</span><span class="p">])</span>
                <span class="n">mac_strain_DFT_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">mac_strain_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
                <span class="c1"># Enforce macroscale strain DFT at the zero-frequency</span>
                <span class="n">mac_strain_DFT_0</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_strain_DFT_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">freq_0_idx</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="c1">#                                      Fixed-point iterative scheme</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Initialize iteration counter:</span>
            <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Start iterative loop</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1">#</span>
                <span class="c1">#                       Stress Discrete Fourier Transform (DFT)</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="c1"># Compute stress Discrete Fourier Transform (DFT)</span>
                <span class="n">stress_DFT_vox</span> <span class="o">=</span> <span class="p">{</span><span class="n">comp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">),</span>
                                                 <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_order</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_order</span><span class="p">:</span>
                    <span class="c1"># Discrete Fourier Transform (DFT) by means of Fast Fourier</span>
                    <span class="c1"># Transform (FFT)</span>
                    <span class="n">stress_DFT_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
                <span class="c1">#</span>
                <span class="c1">#                                        Convergence evaluation</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="c1"># Evaluate convergence criterion</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv_criterion</span> <span class="o">==</span> <span class="s1">&#39;stress_div&#39;</span><span class="p">:</span>
                    <span class="c1"># Compute discrete error</span>
                    <span class="n">discrete_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stress_div_conv_criterion</span><span class="p">(</span>
                        <span class="n">freqs_dims</span><span class="p">,</span> <span class="n">stress_DFT_vox</span><span class="p">)</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv_criterion</span> <span class="o">==</span> <span class="s1">&#39;avg_stress_norm&#39;</span><span class="p">:</span>
                    <span class="c1"># Compute discrete error</span>
                    <span class="n">discrete_error</span> <span class="o">=</span> \
                        <span class="nb">abs</span><span class="p">(</span><span class="n">avg_stress_norm</span> <span class="o">-</span> <span class="n">avg_stress_norm_itold</span><span class="p">)</span> \
                        <span class="o">/</span> <span class="n">avg_stress_norm</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="c1"># Display iteration data</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_display_iteration</span><span class="p">(</span>
                        <span class="nb">iter</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">iter_init_time</span><span class="p">,</span> <span class="n">discrete_error</span><span class="p">)</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="c1"># Check solution convergence and iteration counter</span>
                <span class="k">if</span> <span class="n">discrete_error</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv_tol</span><span class="p">:</span>
                    <span class="c1"># Leave fixed-point iterative scheme</span>
                    <span class="k">break</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="k">elif</span> <span class="nb">iter</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_n_iterations</span> <span class="ow">or</span> \
                        <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">discrete_error</span><span class="p">):</span>
                    <span class="c1"># Set increment cut output</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">discrete_error</span><span class="p">):</span>
                        <span class="n">cut_msg</span> <span class="o">=</span> <span class="s1">&#39;Solution diverged.&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cut_msg</span> <span class="o">=</span> <span class="s1">&#39;Maximum number of iterations reached &#39;</span> <span class="o">+</span> \
                                  <span class="s1">&#39;without convergence.&#39;</span>
                    <span class="c1"># Raise macroscale increment cut procedure</span>
                    <span class="n">is_inc_cut</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># Display increment cut (maximum number of iterations)</span>
                    <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_display_increment_cut</span><span class="p">(</span><span class="n">cut_msg</span><span class="p">)</span>
                    <span class="c1"># Leave fixed-point iterative scheme</span>
                    <span class="k">break</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Increment iteration counter</span>
                    <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># Set iteration initial time</span>
                    <span class="n">iter_init_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="c1">#</span>
                <span class="c1">#                                                 Update strain</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~----~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="c1"># Loop over strain components</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comp_order</span><span class="p">)):</span>
                    <span class="c1"># Get strain component</span>
                    <span class="n">comp_i</span> <span class="o">=</span> <span class="n">comp_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="c1"># Initialize auxiliar variable</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="c1"># Loop over strain components</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comp_order</span><span class="p">)):</span>
                        <span class="c1"># Get strain component</span>
                        <span class="n">comp_j</span> <span class="o">=</span> <span class="n">comp_order</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="c1"># Compute product between Green operator and stress DFT</span>
                        <span class="n">idx1</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">comp_i</span><span class="p">),</span>
                                <span class="n">comp_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">comp_j</span><span class="p">)]</span>
                        <span class="n">idx2</span> <span class="o">=</span> <span class="n">comp_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">comp_j</span><span class="p">)</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">aux</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                                <span class="n">mop</span><span class="o">.</span><span class="n">kelvin_factor</span><span class="p">(</span><span class="n">idx1</span><span class="p">,</span> <span class="n">comp_order</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">gop_dft_vox</span><span class="p">[</span><span class="n">comp_i</span> <span class="o">+</span> <span class="n">comp_j</span><span class="p">],</span>
                                <span class="n">mop</span><span class="o">.</span><span class="n">kelvin_factor</span><span class="p">(</span><span class="n">idx2</span><span class="p">,</span> <span class="n">comp_order</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">stress_DFT_vox</span><span class="p">[</span><span class="n">comp_j</span><span class="p">]))</span>
                    <span class="c1"># Update strain DFT</span>
                    <span class="n">strain_DFT_vox</span><span class="p">[</span><span class="n">comp_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                        <span class="n">strain_DFT_vox</span><span class="p">[</span><span class="n">comp_i</span><span class="p">],</span>
                        <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">mop</span><span class="o">.</span><span class="n">kelvin_factor</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">comp_order</span><span class="p">))</span><span class="o">*</span><span class="n">aux</span><span class="p">)</span>
                    <span class="c1"># Enforce macroscale strain DFT at the zero-frequency</span>
                    <span class="n">freq_0_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="o">*</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
                    <span class="n">strain_DFT_vox</span><span class="p">[</span><span class="n">comp_i</span><span class="p">][</span><span class="n">freq_0_idx</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">mac_strain_DFT_0</span><span class="p">[</span><span class="n">comp_i</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="c1">#              Strain Inverse Discrete Fourier Transform (IDFT)</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="c1"># Compute strain Inverse Discrete Fourier Transform (IDFT)</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_order</span><span class="p">:</span>
                    <span class="c1"># Inverse Discrete Fourier Transform (IDFT) by means of</span>
                    <span class="c1"># Fast Fourier Transform (FFT)</span>
                    <span class="n">strain_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">strain_DFT_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">]))</span>
                <span class="c1">#</span>
                <span class="c1">#                                                 Stress update</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="c1"># Update stress</span>
                <span class="n">stress_vox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elastic_constitutive_model</span><span class="p">(</span><span class="n">strain_vox</span><span class="p">,</span>
                                                              <span class="n">evar1</span><span class="p">,</span> <span class="n">evar2</span><span class="p">,</span>
                                                              <span class="n">evar3</span><span class="p">)</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="c1"># Compute average strain/stress norm</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv_criterion</span> <span class="o">==</span> <span class="s1">&#39;avg_stress_norm&#39;</span><span class="p">:</span>
                    <span class="c1"># Update last iteration average stress norm</span>
                    <span class="n">avg_stress_norm_itold</span> <span class="o">=</span> <span class="n">avg_stress_norm</span>
                    <span class="c1"># Compute average stress norm</span>
                    <span class="n">avg_stress_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_avg_state_vox</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1">#                                   Macroscale strain increment cut</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="k">if</span> <span class="n">is_inc_cut</span><span class="p">:</span>
                <span class="c1"># Reset macroscale strain increment cut flag</span>
                <span class="n">is_inc_cut</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Perform macroscale strain increment cut</span>
                <span class="n">mac_strain_incrementer</span><span class="o">.</span><span class="n">increment_cut</span><span class="p">()</span>
                <span class="c1"># Get current macroscale strain tensor</span>
                <span class="n">mac_strain</span> <span class="o">=</span> <span class="n">mac_strain_incrementer</span><span class="o">.</span><span class="n">get_current_mac_strain</span><span class="p">()</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="c1"># Display increment data</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_display_increment_init</span><span class="p">(</span>
                        <span class="o">*</span><span class="n">mac_strain_incrementer</span><span class="o">.</span><span class="n">get_inc_output_data</span><span class="p">())</span>
                <span class="c1"># Start new macroscale strain increment solution procedure</span>
                <span class="k">continue</span>
            <span class="c1">#</span>
            <span class="c1">#                           Macroscale strain increment convergence</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Compute homogenized strain and stress tensor</span>
            <span class="n">hom_strain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_homogenized_field</span><span class="p">(</span><span class="n">strain_vox</span><span class="p">)</span>
            <span class="n">hom_stress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_homogenized_field</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">)</span>
            <span class="c1"># Append to homogenized strain-stress response</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hom_stress_strain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hom_stress_strain</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">hom_strain</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">),</span> <span class="n">hom_stress</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)))])</span>
            <span class="c1"># Display increment data</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_display_increment_end</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span><span class="p">,</span>
                                                  <span class="n">hom_strain</span><span class="p">,</span> <span class="n">hom_stress</span><span class="p">,</span>
                                                  <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">inc_init_time</span><span class="p">,</span>
                                                  <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">init_time</span><span class="p">)</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Return if last macroscale loading increment</span>
            <span class="k">if</span> <span class="n">mac_strain_incrementer</span><span class="o">.</span><span class="n">get_is_last_inc</span><span class="p">():</span>
                <span class="c1"># Compute material logarithmic strain tensor from deformation</span>
                <span class="c1"># gradient</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;finite&#39;</span><span class="p">:</span>
                    <span class="c1"># Loop over voxels</span>
                    <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                                              <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">]):</span>
                        <span class="c1"># Initialize deformation gradient</span>
                        <span class="n">def_gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">))</span>
                        <span class="c1"># Loop over deformation gradient components</span>
                        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_nsym</span><span class="p">:</span>
                            <span class="c1"># Get second-order array index</span>
                            <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                            <span class="c1"># Get voxel deformation gradient component</span>
                            <span class="n">def_gradient</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">strain_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">voxel</span><span class="p">]</span>
                        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                        <span class="c1"># Compute material logarithmic strain tensor</span>
                        <span class="n">mat_log_strain</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">top</span><span class="o">.</span><span class="n">isotropic_tensor</span><span class="p">(</span>
                            <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">def_gradient</span><span class="p">),</span>
                                             <span class="n">def_gradient</span><span class="p">))</span>
                        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                        <span class="c1"># Loop over material logarithmic strain tensor</span>
                        <span class="c1"># components</span>
                        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span><span class="p">:</span>
                            <span class="c1"># Get second-order array index</span>
                            <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                            <span class="c1"># Store material logarithmic strain tensor</span>
                            <span class="n">strain_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">voxel</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_log_strain</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span>
                <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                <span class="c1"># Return local strain field</span>
                <span class="k">return</span> <span class="n">strain_vox</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Update last converged strain tensor</span>
            <span class="n">strain_old_vox</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">strain_vox</span><span class="p">)</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Setup new macroscale strain increment</span>
            <span class="n">mac_strain_incrementer</span><span class="o">.</span><span class="n">update_inc</span><span class="p">()</span>
            <span class="c1"># Get current macroscale strain tensor</span>
            <span class="n">mac_strain</span> <span class="o">=</span> <span class="n">mac_strain_incrementer</span><span class="o">.</span><span class="n">get_current_mac_strain</span><span class="p">()</span>
            <span class="c1"># Set increment initial time</span>
            <span class="n">inc_init_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># Display increment data</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_display_increment_init</span><span class="p">(</span>
                    <span class="o">*</span><span class="n">mac_strain_incrementer</span><span class="o">.</span><span class="n">get_inc_output_data</span><span class="p">())</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FFTBasicScheme._elastic_constitutive_model"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme._elastic_constitutive_model">[docs]</a>    <span class="k">def</span> <span class="nf">_elastic_constitutive_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strain_vox</span><span class="p">,</span> <span class="n">evar1</span><span class="p">,</span> <span class="n">evar2</span><span class="p">,</span> <span class="n">evar3</span><span class="p">,</span>
                                    <span class="n">finite_strains_model</span><span class="o">=</span><span class="s1">&#39;stvenant-kirchhoff&#39;</span><span class="p">,</span>
                                    <span class="n">is_optimized</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Elastic or hyperelastic material constitutive model.</span>

<span class="sd">        Available constitutive models:</span>

<span class="sd">        *Infinitesimal strains*:</span>

<span class="sd">        * Isotropic linear elastic constitutive model:</span>

<span class="sd">            .. math::</span>

<span class="sd">               \\boldsymbol{\\sigma} = \\boldsymbol{\\mathsf{D}}^{e} :</span>
<span class="sd">                                       \\boldsymbol{\\varepsilon}</span>

<span class="sd">          where :math:`\\boldsymbol{\\sigma}` is the Cauchyevar1 stress tensor,</span>
<span class="sd">          :math:`\\boldsymbol{\\mathsf{D}}^{e}` is the elasticity tensor, and</span>
<span class="sd">          :math:`\\boldsymbol{\\varepsilon}` is the infinitesimal strain</span>
<span class="sd">          tensor.</span>

<span class="sd">        ----</span>

<span class="sd">        *Finite strains*:</span>

<span class="sd">        * Hencky hyperelastic (isotropic) constitutive model:</span>

<span class="sd">            .. math::</span>

<span class="sd">               \\boldsymbol{\\tau} = \\boldsymbol{\\mathsf{D}}^{e} :</span>
<span class="sd">                                     \\boldsymbol{\\varepsilon}</span>

<span class="sd">          where :math:`\\boldsymbol{\\tau}` is the Kirchhoff stress tensor,</span>
<span class="sd">          :math:`\\boldsymbol{\\mathsf{D}}^{e}` is the elasticity tensor, and</span>
<span class="sd">          :math:`\\boldsymbol{\\varepsilon}` is the spatial logarithmic strain</span>
<span class="sd">          tensor.</span>

<span class="sd">        * St.Venant-Kirchhoff hyperelastic (isotropic) constitutive model:</span>

<span class="sd">            .. math::</span>

<span class="sd">               \\boldsymbol{S} = \\boldsymbol{\\mathsf{D}}^{e} :</span>
<span class="sd">                                 \\boldsymbol{E}^{(2)}</span>

<span class="sd">          where :math:`\\boldsymbol{S}` is the second Piola-Kirchhoff stress</span>
<span class="sd">          tensor, :math:`\\boldsymbol{\\mathsf{D}}^{e}` is the elasticity</span>
<span class="sd">          tensor, and :math:`\\boldsymbol{E}^{(2)}` is the Green-Lagrange</span>
<span class="sd">          strain tensor.</span>

<span class="sd">        A detailed description of the computational implementation based on</span>
<span class="sd">        Hadamard (element-wise) operations can be found in Section 4.6 of</span>
<span class="sd">        Ferreira (2022) [#]_.</span>

<span class="sd">        .. [#] Ferreira, B.P. (2022). *Towards Data-driven Multi-scale</span>
<span class="sd">               Optimization of Thermoplastic Blends: Microstructural</span>
<span class="sd">               Generation, Constitutive Development and Clustering-based</span>
<span class="sd">               Reduced-Order Modeling.* PhD Thesis, University of Porto</span>
<span class="sd">               (see `here &lt;https://repositorio-aberto.up.pt/handle/10216/</span>
<span class="sd">               146900?locale=en&gt;`_)</span>

<span class="sd">        ----</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        strain_vox: dict</span>
<span class="sd">            Local strain response (item, numpy.ndarray of shape equal to RVE</span>
<span class="sd">            regular grid discretization) for each strain component (key, str).</span>
<span class="sd">            Infinitesimal strain tensor (infinitesimal strains) or deformation</span>
<span class="sd">            gradient (finite strains).</span>
<span class="sd">        evar1 : numpy.ndarray (2d or 3d)</span>
<span class="sd">            Auxiliar elastic properties array (numpy.ndarray of shape equal to</span>
<span class="sd">            RVE regular grid discretization) containing an elastic</span>
<span class="sd">            properties-related quantity associated to each voxel,</span>

<span class="sd">            .. math ::</span>

<span class="sd">               \\dfrac{E \\nu}{(1 + \\nu)(1 - 2 \\nu)} \\, ,</span>

<span class="sd">            where :math:`E` and :math:`\\nu` are the Young&#39;s Modulus and</span>
<span class="sd">            Poisson&#39;s ratio, respectively.</span>
<span class="sd">        evar2 : numpy.ndarray (2d or 3d)</span>
<span class="sd">            Auxiliar elastic properties array (numpy.ndarray of shape equal to</span>
<span class="sd">            RVE regular grid discretization) containing an elastic</span>
<span class="sd">            properties-related quantity associated to each voxel,</span>

<span class="sd">            .. math ::</span>

<span class="sd">               \\dfrac{E}{1 + \\nu} \\, ,</span>

<span class="sd">            where :math:`E` and :math:`\\nu` are the Young&#39;s Modulus and</span>
<span class="sd">            Poisson&#39;s ratio, respectively.</span>
<span class="sd">        evar3 : numpy.ndarray (2d or 3d)</span>
<span class="sd">            Auxiliar elastic properties array (numpy.ndarray of shape equal to</span>
<span class="sd">            RVE regular grid discretization) containing an elastic</span>
<span class="sd">            properties-related quantity associated to each voxel,</span>

<span class="sd">            .. math ::</span>

<span class="sd">               \\dfrac{E \\nu}{(1 + \\nu)(1 - 2 \\nu)} -</span>
<span class="sd">               \\dfrac{E}{1 + \\nu} \\, ,</span>

<span class="sd">            where :math:`E` and :math:`\\nu` are the Young&#39;s Modulus and</span>
<span class="sd">            Poisson&#39;s ratio, respectively.</span>
<span class="sd">        finite_strains_model : {&#39;hencky&#39;, &#39;stvenant-kirchhoff&#39;}, \</span>
<span class="sd">                               default=&#39;hencky&#39;</span>
<span class="sd">            Finite strains hyperelastic isotropic constitutive model.</span>
<span class="sd">        is_optimized : bool</span>
<span class="sd">            Optimization flag (minimizes loops over spatial discretization</span>
<span class="sd">            voxels).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stress_vox: dict</span>
<span class="sd">            Local stress response (item, numpy.ndarray of shape equal to RVE</span>
<span class="sd">            regular grid discretization) for each stress component (key, str).</span>
<span class="sd">            Cauchy stress tensor (infinitesimal strains) or first</span>
<span class="sd">            Piola-Kirchhoff stress tensor (finite strains).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize Cauchy stress tensor (infinitesimal strains) or first</span>
        <span class="c1"># Piola-Kirchhoff stress tensor (finite strains)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span><span class="p">:</span>
            <span class="n">stress_vox</span> <span class="o">=</span> <span class="p">{</span><span class="n">comp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">))</span>
                          <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span><span class="p">}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;finite&#39;</span><span class="p">:</span>
            <span class="n">stress_vox</span> <span class="o">=</span> <span class="p">{</span><span class="n">comp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">))</span>
                          <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_nsym</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unknown problem strain formulation.&#39;</span><span class="p">)</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Check hyperlastic constitutive model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;finite&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">finite_strains_model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;hencky&#39;</span><span class="p">,</span> <span class="s1">&#39;stvenant-kirchhoff&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unknown hyperelastic constitutive model.&#39;</span><span class="p">)</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Compute finite strains strain tensor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;finite&#39;</span><span class="p">:</span>
            <span class="c1"># Save deformation gradient</span>
            <span class="n">def_gradient_vox</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">strain_vox</span><span class="p">)</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Initialize symmetric finite strains strain tensor</span>
            <span class="n">finite_sym_strain_vox</span> <span class="o">=</span> <span class="p">{</span><span class="n">comp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">))</span>
                                     <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span><span class="p">}</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Compute finite strains strain tensor</span>
            <span class="k">if</span> <span class="n">is_optimized</span><span class="p">:</span>
                <span class="c1"># Compute finite strains strain tensor according to</span>
                <span class="c1"># hyperelastic constitutive model</span>
                <span class="k">if</span> <span class="n">finite_strains_model</span> <span class="o">==</span> <span class="s1">&#39;stvenant-kirchhoff&#39;</span><span class="p">:</span>
                    <span class="c1"># Compute voxelwise material Green-Lagrange strain tensor</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">finite_sym_strain_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">]))</span>
                                 <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
                        <span class="n">finite_sym_strain_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]))</span>
                                 <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
                        <span class="n">finite_sym_strain_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]),</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">finite_sym_strain_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">])),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">],</span>
                                            <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
                        <span class="n">finite_sym_strain_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]),</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">])),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">],</span>
                                            <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">]))</span>
                        <span class="n">finite_sym_strain_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]),</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">])),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">],</span>
                                            <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]))</span>
                        <span class="n">finite_sym_strain_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]),</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">])),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">],</span>
                                            <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
                        <span class="n">finite_sym_strain_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]),</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">])),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">],</span>
                                            <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]))</span>
                        <span class="n">finite_sym_strain_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]),</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span>
                                                   <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">])),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">],</span>
                                            <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Compute voxelwise left Cauchy-Green strain tensor</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">ftfvar11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]))</span>
                        <span class="n">ftfvar22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">]),</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]))</span>
                        <span class="n">ftfvar12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">]),</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ftfvar11</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">])),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span>
                                               <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]))</span>
                        <span class="n">ftfvar12</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">]),</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">])),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span>
                                               <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">]))</span>
                        <span class="n">ftfvar13</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">]),</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">])),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span>
                                               <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]))</span>
                        <span class="n">ftfvar22</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">]),</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">])),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span>
                                               <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">]))</span>
                        <span class="n">ftfvar23</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">]),</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">])),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span>
                                               <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]))</span>
                        <span class="n">ftfvar33</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">]),</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">],</span>
                                                      <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">])),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">],</span>
                                               <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]))</span>
                    <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                    <span class="c1"># Loop over voxels</span>
                    <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                                              <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">]):</span>
                        <span class="c1"># Build left Cauchy-Green strain tensor</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">left_cauchy_green</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ftfvar11</span><span class="p">[</span><span class="n">voxel</span><span class="p">],</span> <span class="n">ftfvar12</span><span class="p">[</span><span class="n">voxel</span><span class="p">],</span>
                                          <span class="n">ftfvar12</span><span class="p">[</span><span class="n">voxel</span><span class="p">],</span> <span class="n">ftfvar22</span><span class="p">[</span><span class="n">voxel</span><span class="p">]]),</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">),</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">left_cauchy_green</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ftfvar11</span><span class="p">[</span><span class="n">voxel</span><span class="p">],</span> <span class="n">ftfvar12</span><span class="p">[</span><span class="n">voxel</span><span class="p">],</span>
                                          <span class="n">ftfvar13</span><span class="p">[</span><span class="n">voxel</span><span class="p">],</span> <span class="n">ftfvar12</span><span class="p">[</span><span class="n">voxel</span><span class="p">],</span>
                                          <span class="n">ftfvar22</span><span class="p">[</span><span class="n">voxel</span><span class="p">],</span> <span class="n">ftfvar23</span><span class="p">[</span><span class="n">voxel</span><span class="p">],</span>
                                          <span class="n">ftfvar13</span><span class="p">[</span><span class="n">voxel</span><span class="p">],</span> <span class="n">ftfvar23</span><span class="p">[</span><span class="n">voxel</span><span class="p">],</span>
                                          <span class="n">ftfvar33</span><span class="p">[</span><span class="n">voxel</span><span class="p">]]),</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">),</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span>
                        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                        <span class="c1"># Compute spatial logarithmic strain tensor</span>
                        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                            <span class="c1"># Supress warnings</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span>
                                <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
                            <span class="c1"># Compute spatial logarithmic strain tensor</span>
                            <span class="n">spatial_log_strain</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">top</span><span class="o">.</span><span class="n">isotropic_tensor</span><span class="p">(</span>
                                <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">left_cauchy_green</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">spatial_log_strain</span><span class="p">))):</span>
                                <span class="n">spatial_log_strain</span> <span class="o">=</span> \
                                    <span class="mf">0.5</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">logm</span><span class="p">(</span><span class="n">left_cauchy_green</span><span class="p">)</span>
                        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                        <span class="c1"># Loop over spatial logarithmic strain tensor</span>
                        <span class="c1"># components</span>
                        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span><span class="p">:</span>
                            <span class="c1"># Get second-order array index</span>
                            <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                            <span class="c1"># Store spatial logarithmic strain tensor</span>
                            <span class="n">finite_sym_strain_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">voxel</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">spatial_log_strain</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Compute finite strains strain tensor according to</span>
                <span class="c1"># hyperelastic constitutive model</span>
                <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                                          <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">]):</span>
                    <span class="c1"># Initialize deformation gradient</span>
                    <span class="n">def_gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">))</span>
                    <span class="c1"># Loop over deformation gradient components</span>
                    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_nsym</span><span class="p">:</span>
                        <span class="c1"># Get second-order array index</span>
                        <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                        <span class="c1"># Get voxel deformation gradient component</span>
                        <span class="n">def_gradient</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">strain_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">voxel</span><span class="p">]</span>
                    <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                    <span class="c1"># Compute finite strains strain tensor according to</span>
                    <span class="c1"># hyperelastic constitutive model</span>
                    <span class="k">if</span> <span class="n">finite_strains_model</span> <span class="o">==</span> <span class="s1">&#39;stvenant-kirchhoff&#39;</span><span class="p">:</span>
                        <span class="c1"># Compute material Green-Lagrange strain tensor</span>
                        <span class="n">mat_green_lagr_strain</span> <span class="o">=</span> \
                            <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">def_gradient</span><span class="p">),</span>
                                           <span class="n">def_gradient</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">))</span>
                        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                        <span class="c1"># Loop over symmetric strain components</span>
                        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span><span class="p">:</span>
                            <span class="c1"># Get second-order array index</span>
                            <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                            <span class="c1"># Store material Green-Lagrange strain tensor</span>
                            <span class="n">finite_sym_strain_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">voxel</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">mat_green_lagr_strain</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Compute spatial logarithmic strain tensor</span>
                        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                            <span class="c1"># Supress warnings</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span>
                                <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
                            <span class="c1"># Compute spatial logarithmic strain tensor</span>
                            <span class="n">spatial_log_strain</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">top</span><span class="o">.</span><span class="n">isotropic_tensor</span><span class="p">(</span>
                                <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">def_gradient</span><span class="p">,</span>
                                                 <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">def_gradient</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">spatial_log_strain</span><span class="p">))):</span>
                                <span class="n">spatial_log_strain</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">logm</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">def_gradient</span><span class="p">,</span>
                                              <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">def_gradient</span><span class="p">)))</span>
                        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                        <span class="c1"># Loop over symmetric strain components</span>
                        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span><span class="p">:</span>
                            <span class="c1"># Get second-order array index</span>
                            <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                            <span class="c1"># Store spatial logarithmic strain tensor</span>
                            <span class="n">finite_sym_strain_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">voxel</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">spatial_log_strain</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Store symmetric finite strains strain tensor</span>
            <span class="n">strain_vox</span> <span class="o">=</span> <span class="n">finite_sym_strain_vox</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Compute Cauchy stress tensor from infinitesimal strain tensor</span>
        <span class="c1"># (infinitesimal strains) or Kirchhoff stress tensor from spatial</span>
        <span class="c1"># logarithmic strain tensor (finite strains)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_problem_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar3</span><span class="p">,</span> <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar1</span><span class="p">,</span> <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]))</span>
            <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar3</span><span class="p">,</span> <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar1</span><span class="p">,</span> <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]))</span>
            <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar2</span><span class="p">,</span> <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar3</span><span class="p">,</span> <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar1</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                         <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">])))</span>
            <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar3</span><span class="p">,</span> <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar1</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                         <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">])))</span>
            <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar3</span><span class="p">,</span> <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar1</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                         <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">])))</span>
            <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar2</span><span class="p">,</span> <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">])</span>
            <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar2</span><span class="p">,</span> <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">])</span>
            <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">evar2</span><span class="p">,</span> <span class="n">strain_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">])</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Compute First Piola-Kirchhoff stress tensor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;finite&#39;</span><span class="p">:</span>
            <span class="c1"># Initialize First Piola-Kirchhoff stress tensor</span>
            <span class="n">first_piola_stress_vox</span> <span class="o">=</span> <span class="p">{</span><span class="n">comp</span><span class="p">:</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">))</span>
                                      <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_nsym</span><span class="p">}</span>
            <span class="c1"># Compute First Piola-Kirchhoff stress tensor</span>
            <span class="k">if</span> <span class="n">is_optimized</span><span class="p">:</span>
                <span class="c1"># Compute First Piola-Kirchhoff stress tensor according to</span>
                <span class="c1"># hyperelastic constitutive model</span>
                <span class="k">if</span> <span class="n">finite_strains_model</span> <span class="o">==</span> <span class="s1">&#39;stvenant-kirchhoff&#39;</span><span class="p">:</span>
                    <span class="c1"># Compute voxelwise First Piola-Kirchhoff stress tensor</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">])),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span>
                                        <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">])),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span>
                                        <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">])),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">],</span>
                                        <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">])),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span>
                                        <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">]))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">])),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span>
                                        <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">]))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">])),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">],</span>
                                        <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">]))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">])),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span>
                                        <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">])),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span>
                                        <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">],</span>
                                               <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">])),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">],</span>
                                        <span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># Compute voxelwise determinant of deformation gradient</span>
                        <span class="n">jvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">])))</span>
                        <span class="c1"># Compute First Piola-Kirchhoff stress tensor</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">])))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">])))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">])))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">])))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Compute voxelwise determinant of deformation gradient</span>
                        <span class="n">jvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                                <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span>
                                                <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">]))),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                                <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span>
                                                <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">])))),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                                <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">]),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">])))))</span>
                        <span class="c1"># Compute voxelwise transpose of inverse of deformation</span>
                        <span class="c1"># gradient</span>
                        <span class="n">fitvar11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">])))</span>
                        <span class="n">fitvar21</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">])))</span>
                        <span class="n">fitvar31</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">])))</span>
                        <span class="n">fitvar12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">])))</span>
                        <span class="n">fitvar22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">])))</span>
                        <span class="n">fitvar32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">])))</span>
                        <span class="n">fitvar13</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">])))</span>
                        <span class="n">fitvar23</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">])))</span>
                        <span class="n">fitvar33</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">jvar</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span>
                                                    <span class="n">def_gradient_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">])))</span>
                        <span class="c1"># Compute First Piola-Kirchhoff stress tensor</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span> <span class="n">fitvar11</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span> <span class="n">fitvar21</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span> <span class="n">fitvar31</span><span class="p">))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;21&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span> <span class="n">fitvar11</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span> <span class="n">fitvar21</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span> <span class="n">fitvar31</span><span class="p">))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;31&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span> <span class="n">fitvar11</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span> <span class="n">fitvar21</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">],</span> <span class="n">fitvar31</span><span class="p">))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span> <span class="n">fitvar12</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span> <span class="n">fitvar22</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span> <span class="n">fitvar32</span><span class="p">))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span> <span class="n">fitvar12</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span> <span class="n">fitvar22</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span> <span class="n">fitvar32</span><span class="p">))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span> <span class="n">fitvar12</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span> <span class="n">fitvar22</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">],</span> <span class="n">fitvar32</span><span class="p">))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">],</span> <span class="n">fitvar13</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span> <span class="n">fitvar23</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span> <span class="n">fitvar33</span><span class="p">))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;12&#39;</span><span class="p">],</span> <span class="n">fitvar13</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;22&#39;</span><span class="p">],</span> <span class="n">fitvar23</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span> <span class="n">fitvar33</span><span class="p">))</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;13&#39;</span><span class="p">],</span> <span class="n">fitvar13</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;23&#39;</span><span class="p">],</span> <span class="n">fitvar23</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">stress_vox</span><span class="p">[</span><span class="s1">&#39;33&#39;</span><span class="p">],</span> <span class="n">fitvar33</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Compute first Piola-Kirchhoff stress tensor according to</span>
                <span class="c1"># hyperelastic constitutive model</span>
                <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                                          <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">]):</span>
                    <span class="c1"># Initialize deformation gradient</span>
                    <span class="n">def_gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">))</span>
                    <span class="c1"># Loop over deformation gradient components</span>
                    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_nsym</span><span class="p">:</span>
                        <span class="c1"># Get second-order array index</span>
                        <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                        <span class="c1"># Get voxel deformation gradient component</span>
                        <span class="n">def_gradient</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">def_gradient_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">voxel</span><span class="p">]</span>
                    <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                    <span class="c1"># Compute first Piola-Kirchhoff stress tensor</span>
                    <span class="k">if</span> <span class="n">finite_strains_model</span> <span class="o">==</span> <span class="s1">&#39;stvenant-kirchhoff&#39;</span><span class="p">:</span>
                        <span class="c1"># Initialize second Piola-Kirchhoff stress tensor</span>
                        <span class="n">second_piola_stress</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">))</span>
                        <span class="c1"># Loop over second Piola-Kirchhoff stress tensor</span>
                        <span class="c1"># components</span>
                        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span><span class="p">:</span>
                            <span class="c1"># Get second-order array index</span>
                            <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                            <span class="c1"># Get voxel second Piola-Kirchhoff stress tensor</span>
                            <span class="c1"># component</span>
                            <span class="n">second_piola_stress</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">stress_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">voxel</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">so_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">so_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">second_piola_stress</span><span class="p">[</span><span class="n">so_idx</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> \
                                    <span class="n">second_piola_stress</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span>
                        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                        <span class="c1"># Compute first Piola-Kirchhoff stress tensor</span>
                        <span class="n">first_piola_stress</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">def_gradient</span><span class="p">,</span>
                                                       <span class="n">second_piola_stress</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Initialize Kirchhoff stress tensor</span>
                        <span class="n">kirchhoff_stress</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">))</span>
                        <span class="c1"># Loop over Kirchhoff stress tensor components</span>
                        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span><span class="p">:</span>
                            <span class="c1"># Get second-order array index</span>
                            <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                            <span class="c1"># Get voxel Kirchhoff stress tensor component</span>
                            <span class="n">kirchhoff_stress</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">voxel</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">so_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">so_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">kirchhoff_stress</span><span class="p">[</span><span class="n">so_idx</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> \
                                    <span class="n">kirchhoff_stress</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span>
                        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                        <span class="c1"># Compute First Piola-Kirchhoff stress tensor</span>
                        <span class="n">first_piola_stress</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span>
                            <span class="n">kirchhoff_stress</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">def_gradient</span><span class="p">)))</span>
                    <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
                    <span class="c1"># Loop over First Piola-Kirchhoff stress tensor components</span>
                    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_nsym</span><span class="p">:</span>
                        <span class="c1"># Get second-order array index</span>
                        <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                        <span class="c1"># Store First Piola-Kirchhoff stress tensor</span>
                        <span class="n">first_piola_stress_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">voxel</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">first_piola_stress</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Set First Piola-Kirchhoff stress tensor</span>
            <span class="n">stress_vox</span> <span class="o">=</span> <span class="n">first_piola_stress_vox</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Return</span>
        <span class="k">return</span> <span class="n">stress_vox</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FFTBasicScheme._stress_div_conv_criterion"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme._stress_div_conv_criterion">[docs]</a>    <span class="k">def</span> <span class="nf">_stress_div_conv_criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs_dims</span><span class="p">,</span> <span class="n">stress_DFT_vox</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convergence criterion based on the divergence of the stress tensor.</span>

<span class="sd">        Convergence criterion proposed by Moulinec and Suquet (1998) [#]_.</span>

<span class="sd">        .. [#] Moulinec, H. and Suquet, P. (1998). *A numerical method for</span>
<span class="sd">               computing the overall response of nonlinear composites with</span>
<span class="sd">               complex microstructure.* Comp Methods Appl M, 157:69-94 (see</span>
<span class="sd">               `here &lt;https://www.sciencedirect.com/science/article/pii/</span>
<span class="sd">               S0045782597002181&gt;`_)</span>

<span class="sd">        ----</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        freqs_dims : list[numpy.ndarray (1d)]</span>
<span class="sd">            List of discrete frequencies (numpy.ndarray (1d)) associated to</span>
<span class="sd">            each spatial dimension.</span>
<span class="sd">        stress_DFT_vox : dict</span>
<span class="sd">            Discrete Fourier Transform of local stress response (item,</span>
<span class="sd">            numpy.ndarray of shape equal to RVE regular grid discretization)</span>
<span class="sd">            for each stress component (key, str). Cauchy stress tensor</span>
<span class="sd">            (infinitesimal strains) or First Piola-Kirchhoff stress tensor</span>
<span class="sd">            (finite strains).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        discrete_error : float</span>
<span class="sd">            Discrete error associated to the convergence criterion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set strain/stress components order according to problem strain</span>
        <span class="c1"># formulation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span><span class="p">:</span>
            <span class="c1"># Infinitesimal strain tensor and Cauchy stress tensor</span>
            <span class="n">comp_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;finite&#39;</span><span class="p">:</span>
            <span class="c1"># Deformation gradient and First Piola-Kirchhoff stress tensor</span>
            <span class="n">comp_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_nsym</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unknown problem strain formulation.&#39;</span><span class="p">)</span>
        <span class="c1"># Compute total number of voxels</span>
        <span class="n">n_voxels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">)</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Initialize discrete error sum</span>
        <span class="n">error_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># Initialize stress DFT at the zero-frequency</span>
        <span class="n">stress_DFT_0_mf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comp_order</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="c1"># Initialize stress divergence DFT</span>
        <span class="n">div_stress_DFT</span> <span class="o">=</span> \
            <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">comp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">)}</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Loop over discrete frequencies</span>
        <span class="k">for</span> <span class="n">freq_coord</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">freqs_dims</span><span class="p">):</span>
            <span class="c1"># Get discrete frequency index</span>
            <span class="n">freq_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">freqs_dims</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">freq_coord</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                              <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">)])</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Initialize stress tensor DFT matricial form</span>
            <span class="n">stress_DFT_mf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comp_order</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
            <span class="c1"># Loop over stress components</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comp_order</span><span class="p">)):</span>
                <span class="c1"># Get stress component</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">comp_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># Build stress tensor DFT matricial form</span>
                <span class="n">stress_DFT_mf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mop</span><span class="o">.</span><span class="n">kelvin_factor</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">comp_order</span><span class="p">)</span> \
                    <span class="o">*</span> <span class="n">stress_DFT_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">freq_idx</span><span class="p">]</span>
                <span class="c1"># Store stress tensor DFT matricial form for zero-frequency</span>
                <span class="k">if</span> <span class="n">freq_idx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="o">*</span><span class="p">(</span><span class="mi">0</span><span class="p">,):</span>
                    <span class="n">stress_DFT_0_mf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mop</span><span class="o">.</span><span class="n">kelvin_factor</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">comp_order</span><span class="p">)</span> \
                        <span class="o">*</span> <span class="n">stress_DFT_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="n">freq_idx</span><span class="p">]</span>
            <span class="c1"># Build stress tensor DFT</span>
            <span class="n">stress_DFT</span> <span class="o">=</span> <span class="n">mop</span><span class="o">.</span><span class="n">get_tensor_from_mf</span><span class="p">(</span><span class="n">stress_DFT_mf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">,</span>
                                                <span class="n">comp_order</span><span class="p">)</span>
            <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
            <span class="c1"># Add discrete frequency contribution to discrete error sum</span>
            <span class="n">error_sum</span> <span class="o">=</span> <span class="n">error_sum</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="n">top</span><span class="o">.</span><span class="n">dot12_1</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">freq_coord</span><span class="p">),</span> <span class="n">stress_DFT</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
            <span class="c1"># Compute stress divergence Discrete Fourier Transform (DFT)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">):</span>
                <span class="n">div_stress_DFT</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="n">freq_idx</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">top</span><span class="o">.</span><span class="n">dot12_1</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">freq_coord</span><span class="p">),</span> <span class="n">stress_DFT</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Compute discrete error</span>
        <span class="n">discrete_error</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_sum</span><span class="o">/</span><span class="n">n_voxels</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">stress_DFT_0_mf</span><span class="p">)</span>
        <span class="c1"># Compute stress divergence Inverse Discrete Fourier Transform (IDFT)</span>
        <span class="n">div_stress</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">comp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">))</span>
                      <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">):</span>
            <span class="c1"># Inverse Discrete Fourier Transform (IDFT) by means of Fast</span>
            <span class="c1"># Fourier Transform (FFT)</span>
            <span class="n">div_stress</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">div_stress_DFT</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]))</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Return</span>
        <span class="k">return</span> <span class="n">discrete_error</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FFTBasicScheme._compute_avg_state_vox"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme._compute_avg_state_vox">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_avg_state_vox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_vox</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute average norm of strain or stress local field.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        state_vox : dict</span>
<span class="sd">            Local strain or stress response (item, numpy.ndarray of shape equal</span>
<span class="sd">            to RVE regular grid discretization) for each strain or stress</span>
<span class="sd">            component (key, str).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        avg_state_norm : float</span>
<span class="sd">            Average norm of strain or stress local field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set strain/stress components order according to problem strain</span>
        <span class="c1"># formulation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span><span class="p">:</span>
            <span class="c1"># Infinitesimal strain tensor and Cauchy stress tensor</span>
            <span class="n">comp_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;finite&#39;</span><span class="p">:</span>
            <span class="c1"># Deformation gradient and First Piola-Kirchhoff stress tensor</span>
            <span class="n">comp_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_nsym</span>
        <span class="c1"># Compute total number of voxels</span>
        <span class="n">n_voxels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">)</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Initialize average strain or stress norm</span>
        <span class="n">avg_state_norm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Loop over strain or stress components</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comp_order</span><span class="p">)):</span>
            <span class="c1"># Get component</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">comp_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># Add contribution to average norm</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span> \
                    <span class="ow">and</span> <span class="n">comp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">comp</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># Account for symmetric component</span>
                <span class="n">avg_state_norm</span> <span class="o">=</span> <span class="n">avg_state_norm</span> \
                    <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">state_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">avg_state_norm</span> <span class="o">=</span> <span class="n">avg_state_norm</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">state_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
        <span class="c1"># Compute average norm</span>
        <span class="n">avg_state_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">avg_state_norm</span><span class="p">))</span><span class="o">/</span><span class="n">n_voxels</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Return</span>
        <span class="k">return</span> <span class="n">avg_state_norm</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FFTBasicScheme._compute_homogenized_field"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme._compute_homogenized_field">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_homogenized_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_vox</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform homogenization over regular grid spatial discretization.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        state_vox : dict</span>
<span class="sd">            Local strain or stress response (item, numpy.ndarray of shape equal</span>
<span class="sd">            to RVE regular grid discretization) for each strain or stress</span>
<span class="sd">            component (key, str).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hom_state : numpy.ndarray (2d)</span>
<span class="sd">            Homogenized strain or stress tensor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set strain/stress components order according to problem strain</span>
        <span class="c1"># formulation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span><span class="p">:</span>
            <span class="c1"># Infinitesimal strain tensor and Cauchy stress tensor</span>
            <span class="n">comp_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;finite&#39;</span><span class="p">:</span>
            <span class="c1"># Deformation gradient and First Piola-Kirchhoff stress tensor</span>
            <span class="n">comp_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_nsym</span>
        <span class="c1"># Compute total number of voxels</span>
        <span class="n">n_voxels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_voxels_dims</span><span class="p">)</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Initialize homogenized strain or stress tensor</span>
        <span class="n">hom_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">))</span>
        <span class="c1"># Loop over strain or stress tensor components</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_order</span><span class="p">:</span>
            <span class="c1"># Get second-order array index</span>
            <span class="n">so_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
            <span class="c1"># Assemble strain or stress component</span>
            <span class="n">hom_state</span><span class="p">[</span><span class="n">so_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">state_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
            <span class="c1"># Account for symmetric component</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span> \
                    <span class="ow">and</span> <span class="n">comp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">comp</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">hom_state</span><span class="p">[</span><span class="n">so_idx</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">state_vox</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
        <span class="c1"># Complete field homogenization</span>
        <span class="n">hom_state</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">n_voxels</span><span class="p">)</span><span class="o">*</span><span class="n">hom_state</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Return</span>
        <span class="k">return</span> <span class="n">hom_state</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FFTBasicScheme.get_hom_stress_strain"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.get_hom_stress_strain">[docs]</a>    <span class="k">def</span> <span class="nf">get_hom_stress_strain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get homogenized strain-stress material response.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _hom_stress_strain : numpy.ndarray (2d)</span>
<span class="sd">            RVE homogenized stress-strain response (item, numpy.ndarray (2d))</span>
<span class="sd">            for each macroscale strain loading identifier (key, int). The</span>
<span class="sd">            homogenized strain and homogenized stress tensor components of the</span>
<span class="sd">            i-th loading increment are stored columnwise in the i-th row,</span>
<span class="sd">            sorted respectively. Infinitesimal strain tensor and Cauchy stress</span>
<span class="sd">            tensor (infinitesimal strains) or Deformation gradient and first</span>
<span class="sd">            Piola-Kirchhoff stress tensor (finite strains).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hom_stress_strain</span><span class="p">)</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FFTBasicScheme._display_greetings"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme._display_greetings">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_display_greetings</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Output greetings.&quot;&quot;&quot;</span>
        <span class="c1"># Get display features</span>
        <span class="n">display_features</span> <span class="o">=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">setdisplayfeatures</span><span class="p">()</span>
        <span class="n">output_width</span><span class="p">,</span> <span class="n">dashed_line</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">display_features</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">tilde_line</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">display_features</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Set output data</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;FFT-Based Homogenization Method (H. Moulinec and P. Suquet)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Implemented by Bernardo Ferreira (bpferreira@fe.up.pt)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Last version: October 2021&#39;</span><span class="p">)</span>
        <span class="c1"># Set output template</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">WHITE</span> <span class="o">+</span> <span class="n">tilde_line</span> <span class="o">+</span> \
                   <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">WHITE</span> <span class="o">+</span> \
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{:^</span><span class="si">{width}</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{:^</span><span class="si">{width}</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{:^</span><span class="si">{width}</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">WHITE</span> <span class="o">+</span> \
                   <span class="n">tilde_line</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Output data</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">output_width</span><span class="p">))</span></div>
        <span class="c1"># ioutil.print2(template.format(*info, width=output_width))</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FFTBasicScheme._display_increment_init"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme._display_increment_init">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_display_increment_init</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="n">subinc_level</span><span class="p">,</span> <span class="n">total_lfact</span><span class="p">,</span> <span class="n">inc_lfact</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Output increment initial data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inc : int</span>
<span class="sd">            Increment number.</span>
<span class="sd">        subinc_level : int</span>
<span class="sd">            Subincrementation level.</span>
<span class="sd">        total_lfact : float</span>
<span class="sd">            Total load factor.</span>
<span class="sd">        inc_lfact : float</span>
<span class="sd">            Incremental load factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get display features</span>
        <span class="n">display_features</span> <span class="o">=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">setdisplayfeatures</span><span class="p">()</span>
        <span class="n">output_width</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">display_features</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">equal_line</span> <span class="o">=</span> <span class="n">display_features</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="k">if</span> <span class="n">subinc_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Set output data</span>
            <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="n">total_lfact</span><span class="p">,</span> <span class="n">inc_lfact</span><span class="p">)</span>
            <span class="c1"># Set output template</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> \
                <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;Increment number: </span><span class="si">{:3d}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> \
                <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">equal_line</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> \
                <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">60</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;Load factor | Total = </span><span class="si">{:8.1e}</span><span class="s1">&#39;</span> \
                <span class="o">+</span> <span class="mi">7</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> \
                <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">72</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;| Incr. = </span><span class="si">{:8.1e}</span><span class="s1">&#39;</span> \
                <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set output data</span>
            <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="n">subinc_level</span><span class="p">,</span> <span class="n">total_lfact</span><span class="p">,</span> <span class="n">inc_lfact</span><span class="p">)</span>
            <span class="c1"># Set output template</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> \
                <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;Increment number: </span><span class="si">{:3d}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="s1">&#39; &#39;</span> \
                <span class="o">+</span> <span class="s1">&#39;(Sub-inc. level: </span><span class="si">{:3d}</span><span class="s1">)&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> \
                <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">equal_line</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> \
                <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">60</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;Load factor | Total = </span><span class="si">{:8.1e}</span><span class="s1">&#39;</span> \
                <span class="o">+</span> <span class="mi">7</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> \
                <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">72</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;| Incr. = </span><span class="si">{:8.1e}</span><span class="s1">&#39;</span> \
                <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Output data</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">output_width</span><span class="p">))</span></div>
        <span class="c1"># ioutil.print2(template.format(*info, width=output_width))</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FFTBasicScheme._display_increment_end"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme._display_increment_end">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_display_increment_end</span><span class="p">(</span><span class="n">strain_formulation</span><span class="p">,</span> <span class="n">hom_strain</span><span class="p">,</span> <span class="n">hom_stress</span><span class="p">,</span>
                               <span class="n">inc_time</span><span class="p">,</span> <span class="n">total_time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Output increment end data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        strain_formulation: {&#39;infinitesimal&#39;, &#39;finite&#39;}</span>
<span class="sd">            Problem strain formulation.</span>
<span class="sd">        hom_strain : numpy.ndarray (2d)</span>
<span class="sd">            Homogenized strain tensor.</span>
<span class="sd">        hom_stress : numpy.ndarray (2d)</span>
<span class="sd">            Homogenized stress tensor.</span>
<span class="sd">        inc_time : float</span>
<span class="sd">            Increment running time.</span>
<span class="sd">        total_time : float</span>
<span class="sd">            Total running time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get display features</span>
        <span class="n">display_features</span> <span class="o">=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">setdisplayfeatures</span><span class="p">()</span>
        <span class="n">output_width</span><span class="p">,</span> <span class="n">dashed_line</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">display_features</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">equal_line</span> <span class="o">=</span> <span class="n">display_features</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">space_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_width</span> <span class="o">-</span> <span class="mi">84</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="n">space_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_width</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;Homogenized strain tensor&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">48</span><span class="p">))</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="n">space_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_width</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;Increment run time (s): &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">44</span><span class="p">))</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="n">space_4</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_width</span> <span class="o">-</span> <span class="mi">72</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Set strain and stress nomenclature</span>
        <span class="k">if</span> <span class="n">strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span><span class="p">:</span>
            <span class="n">strain_header</span> <span class="o">=</span> <span class="s1">&#39;Homogenized strain tensor (</span><span class="se">\u03B5</span><span class="s1">)&#39;</span>
            <span class="n">stress_header</span> <span class="o">=</span> <span class="s1">&#39;Homogenized stress tensor (</span><span class="se">\u03C3</span><span class="s1">)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strain_header</span> <span class="o">=</span> <span class="s1">&#39;Homogenized strain tensor (F)&#39;</span>
            <span class="n">stress_header</span> <span class="o">=</span> <span class="s1">&#39;Homogenized stress tensor (P)&#39;</span>
        <span class="c1"># Get problem number of spatial dimensions</span>
        <span class="n">n_dim</span> <span class="o">=</span> <span class="n">hom_strain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Build strain and stress components list</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_dim</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_dim</span><span class="p">):</span>
                <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hom_strain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_dim</span><span class="p">):</span>
                <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hom_stress</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
        <span class="c1"># Get output data</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">comps</span> <span class="o">+</span> <span class="p">[</span><span class="n">inc_time</span><span class="p">,</span> <span class="n">total_time</span><span class="p">])</span>
        <span class="c1"># Set output template</span>
        <span class="k">if</span> <span class="n">n_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">dashed_line</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                       <span class="n">indent</span> <span class="o">+</span> <span class="n">equal_line</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                       <span class="n">indent</span> <span class="o">+</span> <span class="mi">7</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">strain_header</span> <span class="o">+</span> <span class="n">space_2</span> \
                              <span class="o">+</span> <span class="n">stress_header</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                       <span class="n">indent</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="n">n_dim</span><span class="o">*</span><span class="s1">&#39;</span><span class="si">{:&gt;12.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;  ]&#39;</span> \
                              <span class="o">+</span> <span class="n">space_4</span> <span class="o">+</span> \
                       <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">n_dim</span><span class="o">*</span><span class="s1">&#39;</span><span class="si">{:&gt;12.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;  ]&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                       <span class="n">indent</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="n">n_dim</span><span class="o">*</span><span class="s1">&#39;</span><span class="si">{:&gt;12.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;  ]&#39;</span> \
                              <span class="o">+</span> <span class="n">space_4</span> <span class="o">+</span> \
                       <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">n_dim</span><span class="o">*</span><span class="s1">&#39;</span><span class="si">{:&gt;12.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;  ]&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">dashed_line</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                       <span class="n">indent</span> <span class="o">+</span> <span class="n">equal_line</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                       <span class="n">indent</span> <span class="o">+</span> <span class="mi">7</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">strain_header</span> <span class="o">+</span> <span class="n">space_2</span> \
                              <span class="o">+</span> <span class="n">stress_header</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                       <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="n">n_dim</span><span class="o">*</span><span class="s1">&#39;</span><span class="si">{:&gt;12.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;  ]&#39;</span> <span class="o">+</span> <span class="n">space_1</span> <span class="o">+</span> \
                       <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">n_dim</span><span class="o">*</span><span class="s1">&#39;</span><span class="si">{:&gt;12.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;  ]&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                       <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="n">n_dim</span><span class="o">*</span><span class="s1">&#39;</span><span class="si">{:&gt;12.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;  ]&#39;</span> <span class="o">+</span> <span class="n">space_1</span> <span class="o">+</span> \
                       <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">n_dim</span><span class="o">*</span><span class="s1">&#39;</span><span class="si">{:&gt;12.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;  ]&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                       <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="n">n_dim</span><span class="o">*</span><span class="s1">&#39;</span><span class="si">{:&gt;12.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;  ]&#39;</span> <span class="o">+</span> <span class="n">space_1</span> <span class="o">+</span> \
                       <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">n_dim</span><span class="o">*</span><span class="s1">&#39;</span><span class="si">{:&gt;12.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;  ]&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">template</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">equal_line</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                    <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;Increment run time (s): </span><span class="si">{:&gt;11.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">space_3</span> <span class="o">+</span> \
                    <span class="s1">&#39;Total run time (s): </span><span class="si">{:&gt;11.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Output data</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">output_width</span><span class="p">))</span></div>
        <span class="c1"># ioutil.print2(template.format(*info, width=output_width))</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FFTBasicScheme._display_iteration"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme._display_iteration">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_display_iteration</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="n">iter_time</span><span class="p">,</span> <span class="n">discrete_error</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Output iteration data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iter : int</span>
<span class="sd">            Iteration number.</span>
<span class="sd">        iter_time : float</span>
<span class="sd">            Iteration running time.</span>
<span class="sd">        discrete_error : float</span>
<span class="sd">            Discrete error associated to convergence criterion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get display features</span>
        <span class="n">display_features</span> <span class="o">=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">setdisplayfeatures</span><span class="p">()</span>
        <span class="n">output_width</span><span class="p">,</span> <span class="n">dashed_line</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">display_features</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">equal_line</span> <span class="o">=</span> <span class="n">display_features</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">space_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_width</span> <span class="o">-</span> <span class="mi">29</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="n">space_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_width</span> <span class="o">-</span> <span class="mi">35</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="n">space_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_width</span> <span class="o">-</span> <span class="mi">38</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># Set iteration output header</span>
        <span class="k">if</span> <span class="nb">iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;Iteration&#39;</span> <span class="o">+</span> <span class="n">space_1</span> \
                               <span class="o">+</span> <span class="s1">&#39;Convergence&#39;</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                        <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39; Number    Run time (s)&#39;</span> <span class="o">+</span> <span class="n">space_2</span> <span class="o">+</span> \
                        <span class="s1">&#39;Error&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                        <span class="n">indent</span> <span class="o">+</span> <span class="n">dashed_line</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Set output data</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="n">iter_time</span><span class="p">,</span> <span class="n">discrete_error</span><span class="p">)</span>
        <span class="c1"># Set output template</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39; </span><span class="si">{:^6d}</span><span class="s1">    </span><span class="si">{:^12.4e}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">space_3</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:&gt;11.4e}</span><span class="s1">&#39;</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Output data</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">output_width</span><span class="p">))</span></div>
        <span class="c1"># ioutil.print2(template.format(*info, width=output_width))</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="FFTBasicScheme._display_increment_cut"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme.html#cratepy.clustering.solution.ffthombasicscheme.FFTBasicScheme._display_increment_cut">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_display_increment_cut</span><span class="p">(</span><span class="n">cut_msg</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Output increment cut data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cut_msg : str</span>
<span class="sd">            Increment cut output message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get display features</span>
        <span class="n">display_features</span> <span class="o">=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">setdisplayfeatures</span><span class="p">()</span>
        <span class="n">output_width</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">asterisk_line</span> <span class="o">=</span> <span class="n">display_features</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">display_features</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Set output data</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">()</span>
        <span class="c1"># Set output template</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> \
                   <span class="n">asterisk_line</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                   <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;Increment cut: &#39;</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span> <span class="o">+</span> \
                   <span class="n">cut_msg</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> \
                   <span class="n">asterisk_line</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)]</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span> <span class="o">+</span> \
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Output data</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">output_width</span><span class="p">))</span></div></div>
        <span class="c1"># ioutil.print2(template.format(*info, width=output_width))</span>
<span class="c1"># =============================================================================</span>
<div class="viewcode-block" id="MacroscaleStrainIncrementer"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.html#cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer">[docs]</a><span class="k">class</span> <span class="nc">MacroscaleStrainIncrementer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Macroscale strain loading incrementer.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    _n_dim : int</span>
<span class="sd">        Problem number of spatial dimensions.</span>
<span class="sd">    _comp_order_sym : list[str]</span>
<span class="sd">        Strain/Stress components symmetric order.</span>
<span class="sd">    _comp_order_nsym : list[str]</span>
<span class="sd">        Strain/Stress components nonsymmetric order.</span>
<span class="sd">    _inc : int</span>
<span class="sd">        Increment counter.</span>
<span class="sd">    _total_lfact : float</span>
<span class="sd">        Total load factor.</span>
<span class="sd">    _inc_mac_strain_total : numpy.ndarray (2d)</span>
<span class="sd">        Total incremental macroscale strain second-order tensor. Infinitesimal</span>
<span class="sd">        strain tensor (infinitesimal strains) or deformation gradient (finite</span>
<span class="sd">        strains).</span>
<span class="sd">    _mac_strain : numpy.ndarray (2d)</span>
<span class="sd">        Current macroscale strain second-order tensor. Infinitesimal strain</span>
<span class="sd">        tensor (infinitesimal strains) or deformation gradient (finite</span>
<span class="sd">        strains).</span>
<span class="sd">    _mac_strain_old : numpy.ndarray (2d)</span>
<span class="sd">        Last converged macroscale strain tensor. Infinitesimal strain tensor</span>
<span class="sd">        (infinitesimal strains) or deformation gradient (finite strains).</span>
<span class="sd">    _is_last_inc : bool</span>
<span class="sd">        Last increment flag.</span>
<span class="sd">    _sub_inc_levels : list</span>
<span class="sd">        List of increments subincrementation level.</span>
<span class="sd">    _n_cinc_cuts : int</span>
<span class="sd">        Consecutive increment cuts counter.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    get_inc(self)</span>
<span class="sd">        Get current increment counter.</span>
<span class="sd">    get_current_mac_strain(self)</span>
<span class="sd">        Get current macroscale strain.</span>
<span class="sd">    get_is_last_inc(self)</span>
<span class="sd">        Get last increment flag.</span>
<span class="sd">    get_inc_output_data(self)</span>
<span class="sd">        Get increment output data.</span>
<span class="sd">    update_inc(self)</span>
<span class="sd">        Update increment counter, total load factor and current loading.</span>
<span class="sd">    increment_cut(self)</span>
<span class="sd">        Perform macroscale strain increment cut.</span>
<span class="sd">    _update_mac_strain(self)</span>
<span class="sd">        Update current macroscale strain loading.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="MacroscaleStrainIncrementer.__init__"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.html#cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strain_formulation</span><span class="p">,</span> <span class="n">problem_type</span><span class="p">,</span> <span class="n">mac_strain_total</span><span class="p">,</span>
                 <span class="n">mac_strain_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inc_lfacts</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">],</span> <span class="n">max_subinc_level</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">max_cinc_cuts</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        strain_formulation: {&#39;infinitesimal&#39;, &#39;finite&#39;}</span>
<span class="sd">            Problem strain formulation.</span>
<span class="sd">        problem_type : int</span>
<span class="sd">            Problem type: 2D plane strain (1), 2D plane stress (2),</span>
<span class="sd">            2D axisymmetric (3) and 3D (4).</span>
<span class="sd">        mac_strain_total : numpy.ndarray (2d)</span>
<span class="sd">            Total macroscale strain tensor. Infinitesimal strain tensor</span>
<span class="sd">            (infinitesimal strains) or deformation gradient (finite strains).</span>
<span class="sd">        mac_strain_init : numpy.ndarray (2d), default=None</span>
<span class="sd">            Initial macroscale strain tensor. Infinitesimal strain tensor</span>
<span class="sd">            (infinitesimal strains) or deformation gradient (finite strains).</span>
<span class="sd">        inc_lfacts : list[float], default=[1.0,]</span>
<span class="sd">            List of incremental load factors (float). Default applies the total</span>
<span class="sd">            macroscale strain tensor in a single increment.</span>
<span class="sd">        max_subinc_level : int, default=5</span>
<span class="sd">            Maximum level of macroscale loading subincrementation.</span>
<span class="sd">        max_cinc_cuts : int, default=5</span>
<span class="sd">            Maximum number of consecutive macroscale loading increment cuts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">=</span> <span class="n">strain_formulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_problem_type</span> <span class="o">=</span> <span class="n">problem_type</span>
        <span class="c1"># Get problem type parameters</span>
        <span class="n">n_dim</span><span class="p">,</span> <span class="n">comp_order_sym</span><span class="p">,</span> <span class="n">comp_order_nsym</span> <span class="o">=</span> \
            <span class="n">mop</span><span class="o">.</span><span class="n">get_problem_type_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span> <span class="o">=</span> <span class="n">n_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_sym</span> <span class="o">=</span> <span class="n">comp_order_sym</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_order_nsym</span> <span class="o">=</span> <span class="n">comp_order_nsym</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Set total macroscale strain tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_total</span> <span class="o">=</span> <span class="n">mac_strain_total</span>
        <span class="c1"># Set initial macroscale strain tensor</span>
        <span class="k">if</span> <span class="n">mac_strain_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_init</span> <span class="o">=</span> <span class="n">mac_strain_init</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dim</span><span class="p">)</span>
        <span class="c1"># Set total incremental macroscale strain tensor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span><span class="p">:</span>
            <span class="c1"># Additive decomposition of infinitesimal strain tensor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inc_mac_strain_total</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_total</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_init</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiplicative decomposition of deformation gradient</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inc_mac_strain_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_total</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_init</span><span class="p">))</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Initialize increment counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Initialize current macroscale strain tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_init</span><span class="p">)</span>
        <span class="c1"># Initialize last converged macroscale strain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_old</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain</span><span class="p">)</span>
        <span class="c1"># Set list of incremental load factors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inc_lfacts</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">inc_lfacts</span><span class="p">)</span>
        <span class="c1"># Initialize subincrementation levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_inc_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inc_lfacts</span><span class="p">)</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_subinc_level</span> <span class="o">=</span> <span class="n">max_subinc_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_cinc_cuts</span> <span class="o">=</span> <span class="n">max_cinc_cuts</span>
        <span class="c1"># Initialize consecutive increment cuts counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_cinc_cuts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Initialize last increment flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_last_inc</span> <span class="o">=</span> <span class="kc">False</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="MacroscaleStrainIncrementer.get_inc"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.html#cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.get_inc">[docs]</a>    <span class="k">def</span> <span class="nf">get_inc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current increment counter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        inc : int</span>
<span class="sd">            Increment counter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inc</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="MacroscaleStrainIncrementer.get_current_mac_strain"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.html#cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.get_current_mac_strain">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_mac_strain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current macroscale strain.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mac_strain : 2darray</span>
<span class="sd">            Current macroscale strain tensor. Infinitesimal strain tensor</span>
<span class="sd">            (infinitesimal strains) or deformation gradient (finite strains).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain</span><span class="p">)</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="MacroscaleStrainIncrementer.get_is_last_inc"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.html#cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.get_is_last_inc">[docs]</a>    <span class="k">def</span> <span class="nf">get_is_last_inc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get last increment flag.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        is_last_inc : bool</span>
<span class="sd">            Last increment flag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_last_inc</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="MacroscaleStrainIncrementer.get_inc_output_data"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.html#cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.get_inc_output_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_inc_output_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get increment output data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        inc_data : tuple</span>
<span class="sd">            Increment output data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get increment index</span>
        <span class="n">inc_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inc</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_inc_levels</span><span class="p">[</span><span class="n">inc_idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_lfact</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inc_lfacts</span><span class="p">[</span><span class="n">inc_idx</span><span class="p">])</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="MacroscaleStrainIncrementer.update_inc"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.html#cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.update_inc">[docs]</a>    <span class="k">def</span> <span class="nf">update_inc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update increment counter, total load factor and current loading.&quot;&quot;&quot;</span>
        <span class="c1"># Update last converged macroscale strain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_old</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain</span><span class="p">)</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Increment increment counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inc</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Get increment index</span>
        <span class="n">inc_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inc</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Reset consecutive increment cuts counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_cinc_cuts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Procedure related with the macroscale strain subincrementation: upon</span>
        <span class="c1"># convergence of a given increment, guarantee that the following</span>
        <span class="c1"># increment magnitude is at most one (subincrementation) level above.</span>
        <span class="c1"># The increment cut procedure is performed the required number of times</span>
        <span class="c1"># in order to ensure this progressive recovery towards the prescribed</span>
        <span class="c1"># incrementation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_inc_levels</span><span class="p">[</span><span class="n">inc_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> \
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_inc_levels</span><span class="p">[</span><span class="n">inc_idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">increment_cut</span><span class="p">()</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Update total load factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_lfact</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inc_lfacts</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_inc</span><span class="p">])</span>
        <span class="c1"># Update current macroscale strain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_mac_strain</span><span class="p">()</span>
        <span class="c1"># Check if last increment</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inc</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inc_lfacts</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_last_inc</span> <span class="o">=</span> <span class="kc">True</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="MacroscaleStrainIncrementer.increment_cut"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.html#cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.increment_cut">[docs]</a>    <span class="k">def</span> <span class="nf">increment_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform macroscale strain increment cut.&quot;&quot;&quot;</span>
        <span class="c1"># Get increment index</span>
        <span class="n">inc_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inc</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Increment consecutive increment cuts counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_cinc_cuts</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Check if maximum number of consecutive increment cuts is surpassed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_cinc_cuts</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_cinc_cuts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Maximum number of consecutive increments cuts &#39;</span>
                               <span class="s1">&#39;reached without convergence.&#39;</span><span class="p">)</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Update subincrementation level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_inc_levels</span><span class="p">[</span><span class="n">inc_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_inc_levels</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">inc_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_inc_levels</span><span class="p">[</span><span class="n">inc_idx</span><span class="p">])</span>
        <span class="c1"># Check if maximum subincrementation level is surpassed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_inc_levels</span><span class="p">[</span><span class="n">inc_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_subinc_level</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Maximum subincrementation level reached &#39;</span>
                               <span class="s1">&#39;without convergence.&#39;</span><span class="p">)</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Get current incremental load factor</span>
        <span class="n">inc_lfact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inc_lfacts</span><span class="p">[</span><span class="n">inc_idx</span><span class="p">]</span>
        <span class="c1"># Cut macroscale strain increment in half</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inc_lfacts</span><span class="p">[</span><span class="n">inc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">inc_lfact</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inc_lfacts</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">inc_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inc_lfacts</span><span class="p">[</span><span class="n">inc_idx</span><span class="p">])</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Update total load factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_lfact</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inc_lfacts</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_inc</span><span class="p">])</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Update current macroscale strain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_mac_strain</span><span class="p">()</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
        <span class="c1"># Reset last increment flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_last_inc</span> <span class="o">=</span> <span class="kc">False</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="MacroscaleStrainIncrementer._update_mac_strain"><a class="viewcode-back" href="../../../../_autosummary/cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer.html#cratepy.clustering.solution.ffthombasicscheme.MacroscaleStrainIncrementer._update_mac_strain">[docs]</a>    <span class="k">def</span> <span class="nf">_update_mac_strain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update current macroscale strain loading.&quot;&quot;&quot;</span>
        <span class="c1"># Get increment index</span>
        <span class="n">inc_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inc</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># Get current incremental load factor</span>
        <span class="n">inc_lfact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inc_lfacts</span><span class="p">[</span><span class="n">inc_idx</span><span class="p">]</span>
        <span class="c1"># Compute current macroscale strain loading according to problem strain</span>
        <span class="c1"># formulation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strain_formulation</span> <span class="o">==</span> <span class="s1">&#39;infinitesimal&#39;</span><span class="p">:</span>
            <span class="c1"># Compute incremental macroscale infinitesimal strain tensor</span>
            <span class="n">inc_mac_strain</span> <span class="o">=</span> <span class="n">inc_lfact</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_inc_mac_strain_total</span>
            <span class="c1"># Compute current macroscale infinitesimal strain tensor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_old</span> <span class="o">+</span> <span class="n">inc_mac_strain</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Compute incremental macroscale deformation gradient</span>
            <span class="n">inc_mac_strain</span> <span class="o">=</span> <span class="n">mop</span><span class="o">.</span><span class="n">matrix_root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inc_mac_strain_total</span><span class="p">,</span>
                                             <span class="n">inc_lfact</span><span class="p">)</span>
            <span class="c1"># Compute current macroscale deformation gradient</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inc_mac_strain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mac_strain_old</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Bernardo Ferreira.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>